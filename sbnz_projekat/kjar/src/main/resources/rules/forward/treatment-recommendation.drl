package forward;

import com.ftn.sbnz.model.models.*;
import java.time.LocalDateTime;
import java.util.List;

// R03: Ako verovatnoća_plamenjače ≥70% → preporuči bakarni preparat
rule "R03 - Preporučiti bakarni preparat za plamenjaču"
    when
        $disease: Disease(name == "Plamenjača", probability >= 70.0)
        $treatment: Treatment(name == "Bakarni preparat", recommended == false, blocked == false)
        $crop: Crop()
    then
        $treatment.setRecommended(true);
        $treatment.setRecommendationReason("Visoka verovatnoća plamenjače (" + $disease.getProbability() + "%)");
        
        System.out.println("R03: Preporučen bakarni preparat za plamenjaču");
        System.out.println("     Verovatnoća: " + $disease.getProbability() + "%");
        System.out.println("     Doza: " + $treatment.getDosage());
        System.out.println("     Karenca: " + $treatment.getWithdrawalPeriod() + " dana");
        
        update($treatment);
end

// R04A: Ako pepelnica u vegetativnoj fazi → biološki fungicidi
rule "R04A - Biološki fungicidi za pepelnicu u vegetativnoj fazi"
    when
        $disease: Disease(name == "Pepelnica", probability >= 40.0)
        $crop: Crop(phenophase == Phenophase.VEGETATIVE)
        $treatment: Treatment(type == TreatmentType.BIOLOGICAL, recommended == false, blocked == false)
    then
        $treatment.setRecommended(true);
        $treatment.setRecommendationReason("Pepelnica detektovana (" + $disease.getProbability() + "%) - biološki tretman");
        
        System.out.println("R04A: Preporučen biološki fungicid za pepelnicu u vegetativnoj fazi");
        System.out.println("     Tretman: " + $treatment.getName());
        System.out.println("     Verovatnoća: " + $disease.getProbability() + "%");
        
        update($treatment);
end

// R04B: Ako pepelnica u fazi cvetanja → biološki fungicidi
rule "R04B - Biološki fungicidi za pepelnicu u fazi cvetanja"
    when
        $disease: Disease(name == "Pepelnica", probability >= 40.0)
        $crop: Crop(phenophase == Phenophase.FLOWERING)
        $treatment: Treatment(type == TreatmentType.BIOLOGICAL, recommended == false, blocked == false)
    then
        $treatment.setRecommended(true);
        $treatment.setRecommendationReason("Pepelnica u fazi cvetanja (" + $disease.getProbability() + "%) - biološki tretman");
        
        System.out.println("R04B: Preporučen biološki fungicid za pepelnicu u fazi cvetanja");
        System.out.println("     Tretman: " + $treatment.getName());
        System.out.println("     Verovatnoća: " + $disease.getProbability() + "%");
        
        update($treatment);
end

// R05: Ako pepelnica i fenofaza plodonošenje → samo biološki fungicidi
rule "R05 - Biološki fungicidi u plodonošenju za pepelnicu"
    when
        $disease: Disease(name == "Pepelnica", probability >= 40.0)
        $crop: Crop(phenophase == Phenophase.FRUITING)
        $treatment: Treatment(type == TreatmentType.BIOLOGICAL, recommended == false, blocked == false)
    then
        $treatment.setRecommended(true);
        $treatment.setRecommendationReason("Pepelnica u fazi plodonošenja - samo biološki tretmani");
        
        System.out.println("R05: Preporučen biološki fungicid za pepelnicu u plodonošenju");
        System.out.println("     Tretman: " + $treatment.getName());
        System.out.println("     Razlog: Bezbednost u fazi plodonošenja");
        
        update($treatment);
end

// R08: Ako fuzarijum potvrđen → Trichoderma tretman
rule "R08 - Trichoderma za fuzarijum"
    when
        $disease: Disease(name == "Fuzarijum", probability >= 45.0)
        $treatment: Treatment(name == "Trichoderma", recommended == false, blocked == false)
    then
        $treatment.setRecommended(true);
        $treatment.setRecommendationReason("Fuzarijum detektovan - Trichoderma efikasna");
        
        System.out.println("R08: Preporučen Trichoderma tretman za fuzarijum");
        System.out.println("     Doza: " + $treatment.getDosage());
        
        update($treatment);
end

// R10: Ako virus potvrđen → uklanjanje biljaka, dezinfekcija alata
rule "R10 - Sanitarne mere za virus"
    when
        $disease: Disease(name == "Virus mozaika", probability >= 60.0)
        $treatment: Treatment(type == TreatmentType.SANITARY, recommended == false, blocked == false)
    then
        $treatment.setRecommended(true);
        $treatment.setRecommendationReason("Virus mozaika - potrebne hitne sanitarne mere");
        
        System.out.println("R10: Preporučene sanitarne mere za virus mozaika");
        System.out.println("     Tretman: " + $treatment.getName());
        System.out.println("     HITNO: Sprečiti širenje virusa");
        
        update($treatment);
end

// Novo pravilo: Kombinovani tretman za sive truleži
rule "R16 - Kombinovani tretman za sivu trulež"
    when
        $disease: Disease(name == "Siva trulež", probability >= 30.0)
        $env: EnvironmentalCondition(humidity > 90)
        $treatment1: Treatment(name == "Uklanjanje zaraženih biljaka", recommended == false, blocked == false)
        $treatment2: Treatment(name == "Biološki fungicid", recommended == false, blocked == false)
    then
        $treatment1.setRecommended(true);
        $treatment1.setRecommendationReason("Siva trulež + visoka vlažnost - hitno uklanjanje");
        
        $treatment2.setRecommended(true);
        $treatment2.setRecommendationReason("Preventivni tretman nakon uklanjanja");
        
        System.out.println("R16: Kombinovani tretman za sivu trulež");
        System.out.println("     1. " + $treatment1.getName());
        System.out.println("     2. " + $treatment2.getName());
        System.out.println("     RH: " + $env.getHumidity() + "% - kritično!");
        
        update($treatment1);
        update($treatment2);
end

// Novo pravilo: Preventivni tretman na osnovu CEP alarma
rule "R17 - Preventivni tretman na osnovu CEP alarma"
    when
        $alert: RiskAlert(riskLevel == RiskLevel.HIGH, diseaseName != null)
        $treatment: Treatment(type == TreatmentType.BIOLOGICAL, recommended == false, blocked == false)
        $disease: Disease(name == $alert.diseaseName, probability < 50.0)
    then
        $treatment.setRecommended(true);
        $treatment.setRecommendationReason("Preventivni tretman na osnovu CEP alarma: " + $alert.getMessage());
        
        System.out.println("R17: Preventivni tretman na osnovu CEP alarma");
        System.out.println("     Alarm: " + $alert.getMessage());
        System.out.println("     Tretman: " + $treatment.getName());
        
        update($treatment);
end

// Pravilo za kreiranje dijagnoze kada je verovatnoća dovoljno visoka
rule "Kreiranje dijagnoze - visoka verovatnoća"
    when
        $disease: Disease(probability >= 70.0)
        $result: DiagnosisResult()
        not (DiagnosisResult(probableDiseases contains $disease))
    then
        $result.getProbableDiseases().add($disease);
        $result.addExplanation("DIJAGNOZA: " + $disease.getName() + " sa verovatnoćom " + 
            String.format("%.1f", $disease.getProbability()) + "%");
        
        System.out.println("DIJAGNOZA: " + $disease.getName() + " sa verovatnoćom " + 
            String.format("%.1f", $disease.getProbability()) + "%");
        
        update($result);
end

// Pravilo za sumnjive dijagnoze (umerena verovatnoća)
rule "Kreiranje dijagnoze - umerena verovatnoća"
    when
        $disease: Disease(probability >= 40.0, probability < 70.0)
        $result: DiagnosisResult()
        not (DiagnosisResult(probableDiseases contains $disease))
    then
        $result.getProbableDiseases().add($disease);
        $result.addExplanation("SUMNJA: " + $disease.getName() + " sa verovatnoćom " + 
            String.format("%.1f", $disease.getProbability()) + "% - potrebno dodatno praćenje");
        
        System.out.println("SUMNJA: " + $disease.getName() + " sa verovatnoćom " + 
            String.format("%.1f", $disease.getProbability()) + "%");
        
        update($result);
end

// Pravilo za dodavanje preporučenih tretmana u rezultat
rule "Dodavanje preporučenih tretmana"
    when
        $treatment: Treatment(recommended == true)
        $result: DiagnosisResult()
        not (DiagnosisResult(recommendedTreatments contains $treatment))
    then
        $result.getRecommendedTreatments().add($treatment);
        $result.addExplanation("TRETMAN: " + $treatment.getName() + " (" + $treatment.getType() + 
            ") - " + $treatment.getRecommendationReason());
        
        System.out.println("PREPORUČEN TRETMAN: " + $treatment.getName() + " (" + $treatment.getType() + ")");
        if ($treatment.getRecommendationReason() != null) {
            System.out.println("     Razlog: " + $treatment.getRecommendationReason());
        }
        
        update($result);
end

// PRAVILA ZA BLOKIRANJE TRETMANA

// R18: Blokiranje hemijskih tretmana u fazi plodonošenja ako karenca nije zadovoljena
rule "R18 - Blokiranje hemijskih tretmana zbog karencije"
    salience 200  // Visok prioritet - mora se proveriti pre preporuke
    when
        $treatment: Treatment(
            type == TreatmentType.CHEMICAL, 
            recommended == true,
            withdrawalPeriod > 0
        )
        $crop: Crop(
            phenophase == Phenophase.FRUITING,
            plannedHarvestDate != null
        )
        eval(java.time.temporal.ChronoUnit.DAYS.between(
            java.time.LocalDate.now(), 
            $crop.getPlannedHarvestDate()
        ) < $treatment.getWithdrawalPeriod())
    then
        $treatment.setRecommended(false);
        $treatment.setBlocked(true);
        $treatment.setBlockReason("BLOKIRANO: Karenca (" + $treatment.getWithdrawalPeriod() + 
            " dana) nije zadovoljena. Berba planirana za " + 
            java.time.temporal.ChronoUnit.DAYS.between(java.time.LocalDate.now(), $crop.getPlannedHarvestDate()) + 
            " dana.");
        
        System.out.println("R18: BLOKIRAN TRETMAN - " + $treatment.getName());
        System.out.println("     Razlog: Karenca nije zadovoljena");
        System.out.println("     Potrebno: " + $treatment.getWithdrawalPeriod() + " dana");
        System.out.println("     Dostupno: " + java.time.temporal.ChronoUnit.DAYS.between(
            java.time.LocalDate.now(), $crop.getPlannedHarvestDate()) + " dana");
        
        update($treatment);
end

// R19: Blokiranje hemijskih tretmana u fazi plodonošenja (opšte pravilo)
rule "R19 - Blokiranje hemijskih tretmana u plodonošenju"
    salience 190
    when
        $treatment: Treatment(
            type == TreatmentType.CHEMICAL, 
            recommended == true,
            blocked == false
        )
        $crop: Crop(phenophase == Phenophase.FRUITING)
    then
        $treatment.setRecommended(false);
        $treatment.setBlocked(true);
        $treatment.setBlockReason("BLOKIRANO: Hemijski tretmani nisu dozvoljeni u fazi plodonošenja. Koristite biološke alternative.");
        
        System.out.println("R19: BLOKIRAN HEMIJSKI TRETMAN u plodonošenju - " + $treatment.getName());
        System.out.println("     Preporuka: Koristite biološke fungicide");
        
        update($treatment);
end

// R20: Dodavanje blokiranih tretmana u rezultat (za informaciju)
rule "R20 - Dodavanje blokiranih tretmana u rezultat"
    salience 50
    when
        $treatment: Treatment(blocked == true)
        $result: DiagnosisResult()
    then
        String blockMessage = "⚠️ BLOKIRANO: " + $treatment.getName() + " - " + $treatment.getBlockReason();
        
        // Proveri da li objašnjenje već postoji
        if (!$result.getExplanations().contains(blockMessage)) {
            $result.addExplanation(blockMessage);
            System.out.println("INFO: Blokiran tretman dodat u rezultat - " + $treatment.getName());
        }
        
        // NE koristimo update() da izbegnemo rekurziju
end

// R21: Preporučiti biološke alternative kada je hemijski tretman blokiran
rule "R21 - Biološke alternative za blokirane hemijske tretmane"
    salience 40
    when
        $blockedTreatment: Treatment(type == TreatmentType.CHEMICAL, blocked == true)
        $disease: Disease(probability >= 70.0)
        $bioTreatment: Treatment(type == TreatmentType.BIOLOGICAL, recommended == false, blocked == false)
    then
        $bioTreatment.setRecommended(true);
        $bioTreatment.setRecommendationReason("Alternativa za blokirani hemijski tretman (" + 
            $blockedTreatment.getName() + ") - bezbedno u fazi plodonošenja");
        
        System.out.println("R21: Preporučena biološka alternativa - " + $bioTreatment.getName());
        System.out.println("     Razlog: " + $blockedTreatment.getName() + " je blokiran");
        
        update($bioTreatment);
end

// Pravilo za prioritizaciju tretmana
rule "Prioritizacija tretmana po hitnosti"
    salience 100
    when
        $treatment: Treatment(recommended == true, type == TreatmentType.SANITARY, priority == 0)
        $result: DiagnosisResult()
    then
        $treatment.setPriority(1); // Najviši prioritet za sanitarne mere
        System.out.println("PRIORITET 1 (HITNO): " + $treatment.getName());
        update($treatment);
end

rule "Prioritizacija bioloških tretmana"
    salience 90
    when
        $treatment: Treatment(recommended == true, type == TreatmentType.BIOLOGICAL, priority == 0)
        $result: DiagnosisResult()
    then
        $treatment.setPriority(2);
        System.out.println("PRIORITET 2 (BIOLOŠKI): " + $treatment.getName());
        update($treatment);
end

rule "Prioritizacija hemijskih tretmana"
    salience 80
    when
        $treatment: Treatment(recommended == true, type == TreatmentType.CHEMICAL, priority == 0)
        $result: DiagnosisResult()
    then
        $treatment.setPriority(3);
        System.out.println("PRIORITET 3 (HEMIJSKI): " + $treatment.getName());
        update($treatment);
end